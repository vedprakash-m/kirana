name: API Schema Validation

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'backend/openapi.yaml'
      - '.github/workflows/api-validation.yml'
  push:
    branches: [main]

jobs:
  validate-openapi-schema:
    name: Validate OpenAPI Schema
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install OpenAPI tools
        run: |
          npm install -g @apidevtools/swagger-cli
          npm install -g @stoplight/spectral-cli

      - name: Validate OpenAPI syntax
        run: |
          echo "ğŸ” Validating OpenAPI 3.0.3 syntax..."
          swagger-cli validate backend/openapi.yaml

      - name: Lint OpenAPI with Spectral
        run: |
          echo "ğŸ” Linting OpenAPI spec with Spectral..."
          spectral lint backend/openapi.yaml --ruleset .spectral.yml || true

      - name: Check critical schemas exist
        run: |
          echo "ğŸ” Checking critical schemas..."
          
          # Check Item schema
          if ! grep -q "Item:" backend/openapi.yaml; then
            echo "âŒ Item schema not found"
            exit 1
          fi
          
          # Check PredictionMetadata schema
          if ! grep -q "PredictionMetadata:" backend/openapi.yaml; then
            echo "âŒ PredictionMetadata schema not found"
            exit 1
          fi
          
          # Check factors array in PredictionMetadata
          if ! grep -A 20 "PredictionMetadata:" backend/openapi.yaml | grep -q "factors:"; then
            echo "âŒ PredictionMetadata.factors array not found"
            exit 1
          fi
          
          # Check confidence enum
          if ! grep -q "PredictionConfidence:" backend/openapi.yaml; then
            echo "âŒ PredictionConfidence enum not found"
            exit 1
          fi
          
          # Check standard error response format
          if ! grep -q "ErrorResponse:" backend/openapi.yaml; then
            echo "âŒ ErrorResponse schema not found"
            exit 1
          fi
          
          echo "âœ… All critical schemas found"

      - name: Validate prediction factors structure
        run: |
          echo "ğŸ” Validating prediction factors array structure..."
          
          # Extract PredictionMetadata schema section
          awk '/PredictionMetadata:/,/^[[:space:]]{0,4}[^[:space:]]/' backend/openapi.yaml > /tmp/prediction-metadata.yml
          
          # Check factors array has correct structure
          if ! grep -A 30 "factors:" /tmp/prediction-metadata.yml | grep -q "factor:"; then
            echo "âŒ factors array missing 'factor' property"
            exit 1
          fi
          
          if ! grep -A 30 "factors:" /tmp/prediction-metadata.yml | grep -q "met:"; then
            echo "âŒ factors array missing 'met' property"
            exit 1
          fi
          
          if ! grep -A 30 "factors:" /tmp/prediction-metadata.yml | grep -q "value:"; then
            echo "âŒ factors array missing 'value' property"
            exit 1
          fi
          
          echo "âœ… Prediction factors structure validated"

      - name: Check all endpoints have examples
        run: |
          echo "ğŸ” Checking that all endpoints have examples..."
          
          # Count endpoints (paths with HTTP methods)
          ENDPOINTS=$(grep -E "^\s+(get|post|put|delete|patch):" backend/openapi.yaml | wc -l)
          echo "Found $ENDPOINTS endpoints"
          
          # Count examples in responses
          EXAMPLES=$(grep -c "example:" backend/openapi.yaml || echo 0)
          echo "Found $EXAMPLES examples"
          
          # We should have at least one example per endpoint
          if [ "$EXAMPLES" -lt "$ENDPOINTS" ]; then
            echo "âš ï¸  Warning: Not all endpoints have examples ($EXAMPLES examples for $ENDPOINTS endpoints)"
            # Don't fail - just warn
          else
            echo "âœ… All endpoints have examples"
          fi

      - name: Validate enum consistency
        run: |
          echo "ğŸ” Validating enum consistency..."
          
          # Check PredictionConfidence enum values
          if ! grep -A 10 "PredictionConfidence:" backend/openapi.yaml | grep -q "high"; then
            echo "âŒ PredictionConfidence missing 'high' value"
            exit 1
          fi
          
          if ! grep -A 10 "PredictionConfidence:" backend/openapi.yaml | grep -q "medium"; then
            echo "âŒ PredictionConfidence missing 'medium' value"
            exit 1
          fi
          
          if ! grep -A 10 "PredictionConfidence:" backend/openapi.yaml | grep -q "low"; then
            echo "âŒ PredictionConfidence missing 'low' value"
            exit 1
          fi
          
          if ! grep -A 10 "PredictionConfidence:" backend/openapi.yaml | grep -q "teach_mode"; then
            echo "âŒ PredictionConfidence missing 'teach_mode' value"
            exit 1
          fi
          
          # Check Urgency enum values
          if ! grep -A 10 "Urgency:" backend/openapi.yaml | grep -q "critical"; then
            echo "âŒ Urgency missing 'critical' value"
            exit 1
          fi
          
          if ! grep -A 10 "Urgency:" backend/openapi.yaml | grep -q "warning"; then
            echo "âŒ Urgency missing 'warning' value"
            exit 1
          fi
          
          if ! grep -A 10 "Urgency:" backend/openapi.yaml | grep -q "normal"; then
            echo "âŒ Urgency missing 'normal' value"
            exit 1
          fi
          
          echo "âœ… Enum values validated"

      - name: Check JWT authentication
        run: |
          echo "ğŸ” Checking JWT authentication configuration..."
          
          if ! grep -q "bearerAuth:" backend/openapi.yaml; then
            echo "âŒ Bearer authentication not defined"
            exit 1
          fi
          
          if ! grep -A 5 "bearerAuth:" backend/openapi.yaml | grep -q "type: http"; then
            echo "âŒ Bearer auth not configured as HTTP type"
            exit 1
          fi
          
          if ! grep -A 5 "bearerAuth:" backend/openapi.yaml | grep -q "scheme: bearer"; then
            echo "âŒ Bearer auth scheme not specified"
            exit 1
          fi
          
          echo "âœ… JWT authentication configured correctly"

      - name: Validate error response format
        run: |
          echo "ğŸ” Validating error response format..."
          
          # Check ErrorResponse has success, error, and requestId
          if ! grep -A 20 "ErrorResponse:" backend/openapi.yaml | grep -q "success:"; then
            echo "âŒ ErrorResponse missing 'success' field"
            exit 1
          fi
          
          if ! grep -A 20 "ErrorResponse:" backend/openapi.yaml | grep -q "error:"; then
            echo "âŒ ErrorResponse missing 'error' field"
            exit 1
          fi
          
          # Check error object has code and message
          if ! grep -A 30 "ErrorResponse:" backend/openapi.yaml | grep -A 10 "error:" | grep -q "code:"; then
            echo "âŒ Error object missing 'code' field"
            exit 1
          fi
          
          if ! grep -A 30 "ErrorResponse:" backend/openapi.yaml | grep -A 10 "error:" | grep -q "message:"; then
            echo "âŒ Error object missing 'message' field"
            exit 1
          fi
          
          echo "âœ… Error response format validated"

      - name: Check required HTTP status codes
        run: |
          echo "ğŸ” Checking required HTTP status codes..."
          
          # Check for 401 Unauthorized
          if ! grep -q "'401':" backend/openapi.yaml; then
            echo "âŒ Missing 401 Unauthorized response"
            exit 1
          fi
          
          # Check for 400 Bad Request
          if ! grep -q "'400':" backend/openapi.yaml; then
            echo "âŒ Missing 400 Bad Request response"
            exit 1
          fi
          
          # Check for 404 Not Found
          if ! grep -q "'404':" backend/openapi.yaml; then
            echo "âŒ Missing 404 Not Found response"
            exit 1
          fi
          
          # Check for 500 Internal Server Error
          if ! grep -q "'500':" backend/openapi.yaml; then
            echo "âŒ Missing 500 Internal Server Error response"
            exit 1
          fi
          
          echo "âœ… All required HTTP status codes present"

      - name: Validate budget endpoint
        run: |
          echo "ğŸ” Validating budget tracking endpoint..."
          
          if ! grep -q "/budget/status:" backend/openapi.yaml; then
            echo "âŒ Budget status endpoint not found"
            exit 1
          fi
          
          # Check budget response has required fields
          if ! grep -A 50 "/budget/status:" backend/openapi.yaml | grep -q "dailyCap"; then
            echo "âŒ Budget response missing 'dailyCap' field"
            exit 1
          fi
          
          if ! grep -A 50 "/budget/status:" backend/openapi.yaml | grep -q "currentSpend"; then
            echo "âŒ Budget response missing 'currentSpend' field"
            exit 1
          fi
          
          if ! grep -A 50 "/budget/status:" backend/openapi.yaml | grep -q "remaining"; then
            echo "âŒ Budget response missing 'remaining' field"
            exit 1
          fi
          
          echo "âœ… Budget endpoint validated"

      - name: Generate API documentation
        run: |
          echo "ğŸ“š Generating API documentation..."
          npx redoc-cli bundle backend/openapi.yaml -o api-docs.html
          echo "âœ… Documentation generated: api-docs.html"

      - name: Upload API docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: api-docs.html
          retention-days: 30

      - name: Comment on PR with validation results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ” API Schema Validation Results

            âœ… **OpenAPI 3.0.3 validation passed**

            ### Validated Items:
            - âœ… OpenAPI syntax valid
            - âœ… Critical schemas present (Item, PredictionMetadata, ErrorResponse)
            - âœ… Prediction factors array structure correct
            - âœ… JWT authentication configured
            - âœ… Error response format validated
            - âœ… All required HTTP status codes present (401, 400, 404, 500)
            - âœ… Budget tracking endpoint validated
            - âœ… Enum consistency checked (PredictionConfidence, Urgency)

            ### ğŸ“š Documentation
            API documentation has been generated and is available as a build artifact.

            **Note:** This validation ensures API responses match the OpenAPI specification to prevent contract drift.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Validation summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… API Schema Validation Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "All checks passed:"
          echo "  âœ… OpenAPI 3.0.3 syntax valid"
          echo "  âœ… Critical schemas present"
          echo "  âœ… Prediction factors structure validated"
          echo "  âœ… Enum consistency verified"
          echo "  âœ… JWT authentication configured"
          echo "  âœ… Error response format correct"
          echo "  âœ… Required HTTP status codes present"
          echo "  âœ… Budget endpoint validated"
          echo "  âœ… API documentation generated"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
